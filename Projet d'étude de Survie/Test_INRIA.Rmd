---
title: "Rapport test d'étude de survie INRIA"
author: "Naila Bouterfa"
date: "17/02/2021"
output: 
  html_document:
    toc: true
    toc_depth: 2
    theme: united
    highlight: espresso #kate #(si trop contrasté)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
rm(list=ls())
```


Chargeons dans un premier temps les librairies utilisées ainsi que les données :

Librairies :

```{r message=FALSE, warning=FALSE}
library(stringr)
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(gridExtra)
library(grid)
```

Importation des données :

```{r message=FALSE, warning=FALSE}

SurvivalData=read.delim(file="C:/Users/Naila/Desktop/brca_tcga_clinical.tsv")

# necessaire pour la dernière version de R car la conversion des chaines de caractère en facteur n'est plus faite automatiquement

for (i in 1:dim(SurvivalData)[2]){
if (class(SurvivalData[,i])=="character"){
  SurvivalData[,i]=as.factor(SurvivalData[,i])}
}

# verification
# lapply(SurvivalData,class)

```


Dimensions du dataset :

```{r message=FALSE, warning=FALSE}
dim(SurvivalData)
```
Nous avons ainsi 2164 lignes et 154 colonnes/variables

## Nettoyage des données

Il semblerait qu'il y ait pas mal de données manquantes voyons pour une première variables.

```{r message=FALSE, warning=FALSE}
# Ex : 

length(levels(SurvivalData$case_id))
which(is.na(SurvivalData$case_id)==TRUE)
which(SurvivalData$case_id=="'--")
```

Le nombre de patients soit 1082 patients et ne correspond pas au nombre de ligne en fait il s'agit de la moitié du nombre de lignes, il y a deux ligne pour chaque patient. Il faut vérifier qu'il ne s'agit pas de doublons.

D'un autre coté il n'y a pas de données manquantes pour cette variable.

On va vérifier ces mêmes informations pour toutes les autres variables de la manière qui suit :

```{r message=FALSE, warning=FALSE}

SDvalues=c()
for (i in 1:154){
  SDvalues[i]=length(levels(SurvivalData[,i]))
  names(SDvalues)[i]=colnames(SurvivalData)[i]
}
head(SDvalues)

```

Les résultats obtenus diffèrent selon la classe de la variable, en effet :

```{r message=FALSE, warning=FALSE}

classSD=lapply(SurvivalData,class)
which(classSD!="factor")

```

 On a des 0 pour la classe *integer* representée par les deux variables ci dessus, les autres variables étant de la classe *factor* 
 
 On a des 1 pour les variables de type *factor* qui ont pour champs une valeur identique. On peut le voir ci dessous :
 
```{r}

kable(head(SurvivalData[,names(which(SDvalues==1))])) %>%
  kable_styling(font_size = 9)%>%
  kableExtra::scroll_box(width = "100%", height = "300px")

```
 

 On va vouloir exclure les variables de classe factor dont les champs sont identiques pour chaque observation et non celles de la classe integer car elles n'apportent aucune information utile a notre dataset.

```{r message=FALSE, warning=FALSE}
names(which(SDvalues!=1))

```


 On créee le nouveau dataframe contenant simplement 31 variables au lieu de 154 toutes informatives.

```{r message=FALSE, warning=FALSE}

SData=SurvivalData[,names(which(SDvalues!=1))]

```


On remplace les valeurs manquante representées par la syntaxe '-- par NA

```{r message=FALSE, warning=FALSE}
SData[SData=="'--"]=NA
```

Vérifions la présence de doublons.

```{r message=FALSE, warning=FALSE}

#cat(colnames(SData))

# lignes

dim(SData%>%distinct(case_id,case_submitter_id,age_at_index,days_to_birth,days_to_death,ethnicity,gender,race,vital_status,year_of_birth,year_of_death,age_at_diagnosis,ajcc_pathologic_m,ajcc_pathologic_n,ajcc_pathologic_stage,ajcc_pathologic_t,ajcc_staging_system_edition,days_to_diagnosis,days_to_last_follow_up,icd_10_code,morphology,primary_diagnosis,prior_malignancy,prior_treatment,site_of_resection_or_biopsy,synchronous_malignancy,tissue_or_organ_of_origin,tumor_stage,year_of_diagnosis,treatment_or_therapy,treatment_type))

# colonnes
setequal(SData$site_of_resection_or_biopsy,SData$tissue_or_organ_of_origin)

SData=SData[,-which(colnames(SData)=="site_of_resection_or_biopsy")]

```

Il n'y a pas de doublons. Le nombre de ligne est le même que celui de la table initiale cela signifie qu'au moins une variable diffère en terme de champs pour un même individu.

D'autre part, "days_to_diagnosis" bien que numérique contient une seule valeur "0" et peut être considérée également comme non informative

```{r}
summary(SData$days_to_diagnosis)
```
```{r}
SData=SData[,-which(colnames(SData)=="days_to_diagnosis")]
```


Les variables treatment_therapy et treatment_type sont liée, les champs de treatment_type devraient être des variable auquels la réponse est contenue dans treatment_therapy on peut les combiner en procédant comme ceci :

```{r}

SData=SData%>% pivot_wider(names_from = treatment_type, values_from = treatment_or_therapy)
colnames(SData)[28]="radiation_therapy"
colnames(SData)[29]="pharmaceutical_therapy"

```


Transformons les variables ci dessous de tel sorte que l'on attribue à
"Yes" : 1
"No" : 0
"Not reported" : NA

```{r}

levels(SData$prior_malignancy)	= c(0,NA,1)
levels(SData$synchronous_malignancy)	= c(0,NA)
levels(SData$prior_treatment)	= c(0,NA,1)

levels(SData$radiation_therapy)		= c(0,NA,1)
levels(SData$pharmaceutical_therapy)	= c(0,NA,1)

```


```{r}

levels(SData$race)= c("american indian or alaska native", "asian", "black or african american",NA,"white")

levels(SData$tumor_stage)=c(NA, "stage i", "stage ia", "stage ib", "stage ii", "stage iia", "stage iib", "stage iii", "stage iiia", "stage iiib", "stage iiic", "stage iv", "stage x")

```


Nous pouvons créer une variable qui combine ces deux thérapies et nous renseigne sur la présence ou non de thérapie, on associe ainsi :

"Absence de thérapie" : 0
"Radiothérapie ou Therapie pharmaceutique" : 1
"Radiothérapie et Therapie pharmaceutique" : 2

```{r}

therapy=rep(NA,dim(SData)[1])

therapy=case_when(  
  (SData$radiation_therapy==1 & SData$pharmaceutical_therapy==1) ~ 2,
  (SData$radiation_therapy==1 & SData$pharmaceutical_therapy==0) ~ 1,
  (SData$radiation_therapy==0 & SData$pharmaceutical_therapy==1) ~ 1,
  (SData$radiation_therapy==0 & SData$pharmaceutical_therapy==0) ~ 0)   

therapy=as.factor(therapy)

SData=cbind(SData,therapy)

```


En résulte finalement le dataframe suivant :

```{r message=FALSE, warning=FALSE}

SData=as.data.frame(SData)

kable(head(SData)) %>%
  kable_styling(font_size = 9)%>%
  kableExtra::scroll_box(width = "100%", height = "300px")

```

Nous avons dans celui ci 30 variables et 1082 lignes/patients



## Exploration des données


### Catégories et données manquantes

Pour toute variable nous pouvons voir dans le tableau ci dessous le nombre de catégories associés à la variable et la présence ou nom de valeurs manquantes :

```{r message=FALSE, warning=FALSE}


SD=matrix(NA,dim(SData)[2],3)

for (i in 1:dim(SData)[2]){
  SD[i,1]=colnames(SData)[i]
  SD[i,2]=length(levels(SData[,i]))
  SD[i,3]=length(which(is.na(SData[,i])))
}

colnames(SD)=c("Variables","Levels","NAs")
SD=as.data.frame(SD)
SD$NAs=as.numeric(as.character(SD$NAs))
SD$Levels=as.numeric(as.character(SD$Levels))

kable(SD)%>%kable_paper("hover", full_width = F,position = "left") %>%
  kable_styling(font_size = 12)%>%
  kableExtra::scroll_box(width = "100%", height = "300px")
```


## Analyse descriptive et visualisation 

 Variables catégorielles et effectifs:
 
 Informations élémentaires sur les patients :

```{r message=FALSE, warning=FALSE, fig.width=5, fig.height=4}

ggplot(SData,aes(gender))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold"))+
  ggtitle("Patient's gender distribution") +
  xlab("Gender") + ylab("Number of patients")
kable(table(SData$gender),col.names = c("Gender","Counts"),caption = "Gender")%>%
  kable_styling(font_size = 12)

ggplot(SData,aes(race))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle("Patients race distribution") +
  xlab("Race") + ylab("Number of patients")
kable(table(SData$race),col.names = c("Race","Counts"),caption = "Race")%>%
  kable_styling(font_size = 12)

ggplot(SData,aes(vital_status))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold"))+
  ggtitle("Vital status of patients") +
  xlab("Vital status") + ylab("Number of patients")
kable(table(SData$vital_status),col.names = c("Vital status","Counts"),caption = "Vital status")%>%kable_styling(font_size = 12)
```

Historique des patient par rapport à la maladie et au traitement :

```{r message=FALSE, warning=FALSE, fig.width=10, fig.height=4}

grid.arrange(ggplot(SData,aes(prior_malignancy))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold"))+
  ggtitle("Prior malignancy in patients") +
  xlab("Prior malignancy") + ylab("Number of patients"),
ggplot(SData,aes(prior_treatment))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold"))+
  ggtitle("Prior treatments in patients") +  
  xlab("Prior treatments") + ylab("Number of patients"),
ncol = 2,widths=c(4,4))

kable(cbind(table(SData$prior_malignancy),table(SData$prior_treatment)),col.names = c("prior_malignancy","prior_treatment"),caption = "Retrospective situation of patients")%>%kable_styling(font_size = 12)

```

Autres variables peu informatives :
```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=4}

grid.arrange(ggplot(SData,aes(tissue_or_organ_of_origin))+
  geom_bar()+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle(" ") +
  xlab("tissue/organ of origin") + ylab("Number of patients"),
ggplot(SData,aes(synchronous_malignancy))+
  geom_bar()+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle(" ") +
  xlab("Synchronous malignancy") + ylab("Number of patients"),ncol = 2,widths=c(7,6)
)


```


Stage de la tumeur :

```{r message=FALSE, warning=FALSE, fig.width=5, fig.height=4}

ggplot(SData,aes(tumor_stage))+
  geom_bar()+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle("Tumor stage of patients") +
  xlab("Tumor stage") + ylab("Number of patients")

kable(table(SData$tumor_stage),col.names = c("Tumor stage","Counts"),caption = "Tumor stage")%>%kable_styling(font_size = 12)%>%
  kableExtra::scroll_box(width = "100%", height = "300px")

```
Types de thérapies :

```{r message=FALSE, warning=FALSE, fig.width=10, fig.height=4}



grid.arrange(ggplot(SData,aes(radiation_therapy))+
  geom_bar()+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold"))+
  ggtitle("Patients who received Radiation therapy ") +
  xlab("Radiation Therapy") + ylab("Nombre de participants"),
ggplot(SData,aes(pharmaceutical_therapy))+
  geom_bar()+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold"))+
  ggtitle("Patients who received Pharmaceutical therapy ") +
  xlab("Pharmaceutical Therapy") + ylab("Nombre de participants"),ncol = 2,widths=c(4,4))


kable(cbind(table(SData$radiation_therapy),table(SData$pharmaceutical_therapy)),col.names = c("Radiation Therapy","Pharmaceutical Therapy"),caption = "Type of treatment received")%>%kable_styling(font_size = 12)

```

Variables ajcc :

```{r message=FALSE, warning=FALSE, fig.width=10, fig.height=4}


grid.arrange(ggplot(SData,aes(ajcc_pathologic_m))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle(" ") +
  xlab("ajcc_pathologic_m") + ylab("Number of patients"),
ggplot(SData,aes(ajcc_pathologic_n))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle("") +
  xlab("ajcc_pathologic_n") + ylab("Number of patients"),
ncol = 2,widths=c(3,6))

grid.arrange(ggplot(SData,aes(ajcc_pathologic_stage))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle("") +
  xlab("ajcc_pathologic_stage") + ylab("Number of patients"),
ggplot(SData,aes(ajcc_pathologic_t))+
  geom_bar(width = 0.7, position = position_dodge(width = 0.9))+
  theme(axis.text = element_text(family = "serif", size = 10, face = "bold",angle = 30, hjust=1))+
  ggtitle("") +
  xlab("ajcc_pathologic_t") + ylab("Number of patients"),
ncol = 2,widths=c(4,4))



```

Variable continue (age de diagnostique) :

```{r message=FALSE, warning=FALSE, fig.width=5, fig.height=4}

summary(SData$age_at_index)

ggplot(SData, aes(y = age_at_index)) + geom_boxplot()+
  ggtitle("Boxplot of the age of index/diagnosis") 

```

```{r}

```



# Analyse de survie


### Données relatives au temps :


Nous identifions les variables temporelles et dates que nous allons explorer.

```{r}

#"days_to_diagnosis" :  retiré car il ne s'agit pas d'une variable, elle ne varie justement pas et représente pour notre jeu de données la date de début de suivi ou d'étude

TimeSD=SData[,c("age_at_index","age_at_diagnosis","year_of_diagnosis","days_to_birth","year_of_birth","days_to_death","year_of_death","days_to_last_follow_up")]

kable(TimeSD) %>%
  kable_styling(font_size = 9)%>%
  kableExtra::scroll_box(width = "100%", height = "300px")

```

*Days to birth* et *age at diagnosis* contiennent la même information symétrique :

```{r}
setequal(-as.numeric(as.character(SData$days_to_birth)),SData$age_at_diagnosis)
```

De même *age at index* et *age at diagnosis* contiennent la même information l'une donnée en jours et l'autre en années

```{r}
#intersect(as.numeric(as.character(SData$age_at_index)),floor(as.numeric(as.character(SData$age_at_diagnosis))/365.25))

#as.numeric(as.character(SData$age_at_index))-floor(as.numeric(as.character(SData$age_at_diagnosis))/365.25)
```

Et en additionnant *year of birth* et *age at index* on obtient le même vecteur que *year of diagnosis*

```{r}
setequal(as.numeric(as.character(SData$year_of_birth))+as.numeric(as.character(SData$age_at_index)),SData$year_of_diagnosis)
```

La variable *days to death* est renseignée pour les patients décédés et est comptabilisée à partir de l'index ou le diagnostique. On peut le voir entre autre pour le patient 11 :

```{r}
#which(TimeSD$days_to_death!="NA")
TimeSD[11,]
```

En effet, on peut le vérifier en comparant le vecteur *year of death* au vecteur *years to death* additionné au *year at diagnosis*

```{r}
tmp=data.frame(cbind(as.numeric(as.character(SData$year_of_death)),as.numeric(as.character(SData$year_of_diagnosis))+floor(as.numeric(as.character(SData$days_to_death))/365.25)))%>%drop_na()
  
setequal(tmp[,1],tmp[,2])
```

On peut considerer *days to last follow up* est disponible quand le patient est vivant :

```{r}

which(is.na(TimeSD$days_to_last_follow_up)==FALSE & is.na(TimeSD$year_of_death)==FALSE)

which(is.na(TimeSD$days_to_last_follow_up)==FALSE & is.na(TimeSD$days_to_death)==FALSE)

```

Ce n'est pas le cas pour la variable *days to death*. On trouve des patients pour lesquels les deux champs sont renseignés simultanemment.


Pour résumer les variables ;

- age_at_index, age_at_diagnosis et year_of_diagnosis font référence à la même chose dans deux unités de temps différentes d'un "age" communiqué au même temps qui est year_of diagnosis mais on pourrait aussi dire age at index ou year of index.

- La variable year_of_birth et days to birth se rapportent toutes deux à la naissance du patient days_to_birth est calculée par rapport à l'index. (les valeurs sont négatives car la naissance prédate le diagnostique)

- La variable year_of_death et days_to_death se rapportent toutes deux au décèd du patient (si il y a) days_to_death est également calculée par rapport à l'index.

- Enfin la variable days_to_follow_up est présente pour les patients vivants et sont a priori aussi calculées par rapport à l'index/diagnostique.
(les valeurs sont postives car ces évenement ont lieu quant à eux post-diagnostique)




**Préparons les données à l'analyse de survie :**



Convertissons les variables ci-dessous en variables numériques :

```{r}
SData$days_to_death=as.numeric(as.character(SData$days_to_death))
SData$days_to_last_follow_up=as.numeric(as.character(SData$days_to_last_follow_up))
```

Convertissons la variable vital_status en variable catégorielle numérique :
  
```{r}


SData$vital_status=as.character(SData$vital_status)
SData$vital_status[which(SData$vital_status=="Alive")]=0
SData$vital_status[which(SData$vital_status=="Dead")]=1
SData$vital_status=as.numeric(SData$vital_status)

class(SData$vital_status)

```


Regardons les variables qui nous interessent de plus près :

```{r}
tmp=SData[,c("vital_status","year_of_death","days_to_death","days_to_last_follow_up")]

kable(head(tmp)) %>%
  kable_styling(font_size = 9)
```

Pour définir notre objet de survie, il nous faudra deux variables :

Une première, temporelle, indiquant la durée à laquelle survient l’évènement étudié (ici le décès) pour ceux ayant vécu l’évènement et la durée d’observation pour ceux n’ayant pas vécu l’évènement (censure à droite). 

Une seconde variable indiquant si les individus ont vécu l’évènement. Ici et conventionellement la variable survie est codée 1 pour les décès et 0 pour ceux ayant survécu. 


```{r}
kable(head(tmp[which(is.na(tmp$days_to_last_follow_up)==FALSE & is.na(tmp$days_to_death)==FALSE),])) %>%
  kable_styling(font_size = 9)
```
  
  
Verifions si il existe des patients pour lesquels les valeurs de "days_to_last_follow_up" sont superieurs à "days_to_death"

```{r}

 which(tmp[which(is.na(TimeSD$days_to_last_follow_up)==FALSE & is.na(TimeSD$days_to_death)==FALSE),]$days_to_death<tmp[which(is.na(TimeSD$days_to_last_follow_up)==FALSE & is.na(TimeSD$days_to_death)==FALSE),]$days_to_last_follow_up)
 
```


Corrigeons les données et créons la variable **time_fu** :

On va considerer que pour les individus ou les deux dates sont renseignées simultanemment avec days_to_death superieures a days_to_last_follow_up que les individus sont censurés donc vivants et leur affecter la valeur days_to_last_follow_up dans une nouvelle variable

```{r}

table(SData$vital_status)

SData=SData%>%mutate(vital_status = if_else((vital_status == 1 & is.na(days_to_last_follow_up)== FALSE), 0, vital_status))

table(SData$vital_status)


SData=SData%>%mutate(time_fu = if_else(vital_status == 1, days_to_death, days_to_last_follow_up))


class(SData$vital_status) 


# On peut egalement exclure des données les patients pour lesquels time_fu<0
SData=SData[-which(SData$time_fu<0),]


# Vérifions nos résultats pour notre liste d'individus

kable(head(SData[which(is.na(TimeSD$days_to_last_follow_up)==FALSE & is.na(TimeSD$days_to_death)==FALSE),c("vital_status","year_of_death","days_to_death","days_to_last_follow_up","time_fu")])) %>%
  kable_styling(font_size = 9)

```





### Estimation de la survie


Importons les libraries propre à l'analyse de survie

```{r message=FALSE, warning=FALSE}
library(survival)  
library(survminer)
```


```{r}

fit = survfit(formula = Surv(time_fu,vital_status) ~ 1, data = SData)
fit


d <- data.frame(time = fit$time,
                  n.risk = fit$n.risk,
                  n.event = fit$n.event,
                  n.censor = fit$n.censor,
                  surv = fit$surv,
                  upper = fit$upper,
                  lower = fit$lower
                  )



kable(d) %>%
  kable_styling(font_size = 9)%>%
  kableExtra::scroll_box(width = "100%", height = "300px")

```

Considerons l'estimation de la survie a différents temps :

```{r}
summary(survfit(Surv(time_fu, vital_status) ~ 1, data = SData), times = 365.25)
```

La survie à 1 an du diagnostique est estimée à environ 98,5%


```{r}
summary(survfit(Surv(time_fu, vital_status) ~ 1, data = SData), times = 730.5)

```

La survie à 2 ans du diagnostique est estimée à environ 96,6%


La médiane (délai dans lequel la moitié des individus d'un échantillon sont décédés) n'est pas atteinte ici.

On peut cependant voir les valeurs associes a différent quantiles :

```{r}
tmp=survfit(Surv(time_fu, vital_status) ~ 1, data = SData)
quantile(tmp, 1:5/10)$quantile/365.25
```

On en conclut que la survie est a priori plutot bonne.

Les chances que le patient pris au hasard d'être en vie avant le délai de 4 ans et demi du diagnostique est par exemple de 90%





### Courbe de Kaplan-Meier : 


La courbe de survie permet de décrire le pourcentage de patients sans événement (encore en vie) au cours du temps. La méthode utilisée ici est la méthode de Kaplan Meier. 

```{r message=FALSE, warning=FALSE}

ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",
           xlab="Jours",
           ylab="Probabilité de survie",
           ggtheme = theme_bw())

```
  
  

### Comparaison de la survie chez plusieurs groupes
  
  
  
#### Tests du Log rank 


Les hypothèses du test :
H0 : pas de différence de survie entre les deux groupes étudiés 
H1 : différence de survie entre les deux groupes étudiés
  
```{r}

survdiff(formula = Surv(time_fu,vital_status) ~ gender, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ race, data = SData)


survdiff(formula = Surv(time_fu,vital_status) ~ radiation_therapy, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ pharmaceutical_therapy, data = SData)


survdiff(formula = Surv(time_fu,vital_status) ~ prior_malignancy, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ prior_treatment, data = SData)


survdiff(formula = Surv(time_fu,vital_status) ~ tumor_stage, data = SData)


survdiff(formula = Surv(time_fu,vital_status) ~ ajcc_pathologic_m, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ ajcc_pathologic_n, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ ajcc_pathologic_stage, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ ajcc_pathologic_t, data = SData)


survdiff(formula = Surv(time_fu,vital_status) ~ therapy, data = SData)

survdiff(formula = Surv(time_fu,vital_status) ~ age_at_index, data = SData)


```

Les variables radiation_therapy, pharmaceutical_therapy, tumor_stage, ajcc_pathologic_m, ajcc_pathologic_n, ajcc_pathologic_t, ajcc_pathologic_stage, therapy et age_at_index sont les variables pour lesquelles le test du log Rank est significatif.

On rejette H0 : Le test du Log-rank nous dit que les événements ne surviennent pas avec
la même fréquence ou pas au même moment dans les deux groupes, la survie est différente dans les différents groupes.


Comparons les survie pour différentes variables :
  


```{r message=FALSE, warning=FALSE, fig.width=7, fig.height=5.5}

fit = survfit(formula = Surv(time_fu,vital_status) ~ pharmaceutical_therapy, data = SData)
ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",tables.height = 0.25)

fit = survfit(formula = Surv(time_fu,vital_status) ~ radiation_therapy, data = SData)
ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",tables.height = 0.25)

fit = survfit(formula = Surv(time_fu,vital_status) ~ therapy, data = SData)
ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",tables.height = 0.25)

fit = survfit(formula = Surv(time_fu,vital_status) ~ ajcc_pathologic_m, data = SData)
ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",tables.height = 0.25)

fit = survfit(formula = Surv(time_fu,vital_status) ~ prior_malignancy, data = SData)
ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",tables.height = 0.25)

```
  
  
```{r fig.height=8.5, message=FALSE, warning=FALSE, , fig.width=8.5}
fit = survfit(formula = Surv(time_fu,vital_status) ~ tumor_stage, data = SData)
ggsurvplot(fit, data = SData, pval = TRUE, risk.table = TRUE, surv.median.line = "hv",tables.height = 0.4)
```
  
  
  
### Modèles de Cox :


#### Modèle de Cox univarié 


Si le test du log-rank permet de tester une différence significative de survie entre deux groupes par exemple, il n’est pas possible d’estimer l’étendu de l’impact de cette différence entre ces deux groupes. 

Pour de quantifier cet impact, on fait appel au risque instantané h de décès de chacun des deux groupes (la probabilité selon laquelle un événement précis se produira à un instant fixé) et on cherche une fonction simple les reliant en se basant sur une hypothèse essentielle : *"la proportion des risques instantanés de décès est constante pendant toute la durée d’observation"*. Le modèle de Cox repose sur cette notion de risques proportionnels.

Considérons un modèle univarié avec la variable therapy :

```{r}

mod1=coxph(Surv(time_fu, vital_status) ~ therapy, data = SData)

mod1

coxph(Surv(time_fu, vital_status) ~ therapy, data = SData) %>% 
  gtsummary::tbl_regression(exp = TRUE) 

ggforest(mod1)

```


Le risque proportionnel HR correspond à l’impact (en proportion) d’un groupe de traitement proportionnelement au groupe de référence sur le risque global h

HR < 1 indique un risque réduit.
HR > 1 indique un risque augmenté.

Le test est significatif (P< 0.05);
L’effet des thérapies (therapie = 1) diminue le risque h de décès d’un facteur 0.29, soit un risque de décès dans le groupe sans thérapie qui est 1/0.29 = 3.41 fois supérieur à celui du groupe avec thérapie

L’effet des thérapies (therapie = 2) diminue le risque h de décès d’un facteur 0.18, soit un risque de décès dans le groupe sans thérapies qui est 1/0.18 = 5.6 fois supérieur à celui du groupe traitement+radiothrapie.


On pourrait considerer un autre modèle pour évaluer l'impact de l'age de diagnostique une variable continue sur la survie.

```{r}

coxph(Surv(time_fu, vital_status) ~ age_at_index, data = SData) %>% 
  gtsummary::tbl_regression(exp = TRUE) 

```

Le test est significatif et il s'emblerait que l'augmentation de l'âge de diagnostique aurait quant à elle un impact negatif sur la survie (HR>0) 







#### Modèle de Cox multivarié 

Considerons maintenant un modèle multivariés en introduisant les variables qui nous semblent intressantes :


```{r message=FALSE, warning=FALSE}

mod2=coxph(Surv(time_fu, vital_status) ~ 
             age_at_index+ 
             tumor_stage+
             ajcc_pathologic_n+
             ajcc_pathologic_m+
             ajcc_pathologic_t+
             prior_malignancy+
             prior_treatment+
             radiation_therapy+
             pharmaceutical_therapy, data = SData)
mod2

mod2 %>% gtsummary::tbl_regression(exp = TRUE) 


```





  **Selection de variables :**
  
Voyons si nous pouvons, avec la fonction step, améliorer notre modèle par minimisation de l’AIC.

Pour procéder, on doit supprimer les données manquantes pour que la fonction step() fonctionne :

```{r message=FALSE, warning=FALSE}

#On va d'abord selectionner les variables de notre modèle dans un sous table afin d'eliminer les données manquantes :

tmp=na.omit(SData[,c("vital_status","time_fu","age_at_index", "ajcc_pathologic_n", "ajcc_pathologic_m", "ajcc_pathologic_t", "prior_malignancy", "prior_treatment", "radiation_therapy",  "pharmaceutical_therapy", "tumor_stage","therapy")])

m2=coxph(Surv(time_fu, vital_status) ~ 
             age_at_index+
             tumor_stage+
             ajcc_pathologic_n+
             ajcc_pathologic_m+
             ajcc_pathologic_t+
             prior_malignancy+
             prior_treatment+
             radiation_therapy+
             pharmaceutical_therapy, data = tmp)


stp=step(m2, trace = 1)

```

Avec un AIC =  591.65 minimal pour ce subset (sans valeurs manquantes) on choisit le modèle avec les variables age_at_index, tumor_stage, ajcc_pathologic_n,  ajcc_pathologic_m, prior_malignancy, radiation_therapy pour modèle de Cox multivarié.

Revenons au jeu de donnes initial :

```{r message=FALSE, warning=FALSE}
AIC(coxph(formula = Surv(time_fu, vital_status) ~ age_at_index + 
    tumor_stage + ajcc_pathologic_n + ajcc_pathologic_m + prior_malignancy + 
    radiation_therapy, data = SData))

AIC(coxph(formula = Surv(time_fu, vital_status) ~ age_at_index + 
    tumor_stage + ajcc_pathologic_n + ajcc_pathologic_m + prior_malignancy + 
    therapy, data = SData))
```

Ainsi le modèle définitif est le suivant :

```{r message=FALSE, warning=FALSE}

mod2=coxph(formula = Surv(time_fu, vital_status) ~ age_at_index + 
    tumor_stage + ajcc_pathologic_n + ajcc_pathologic_m + prior_malignancy + 
    therapy, data = SData)

mod2 %>% gtsummary::tbl_regression(exp = TRUE) 

```

On peut aussi comparer les deux modèle univarié et multivarié en réalisant un test de Fisher pour modèles emboités avec la fonction anova()

```{r message=FALSE, warning=FALSE}
m1=coxph(formula = Surv(time_fu, vital_status) ~ therapy, data = tmp)
m2=coxph(formula = Surv(time_fu, vital_status) ~ age_at_index + 
    tumor_stage + ajcc_pathologic_n + ajcc_pathologic_m + prior_malignancy + 
    therapy, data = tmp)


anova(m1, m2, test="Chisq")

```
Il est significatif et en faveur du modèle multivarié

Testons l'hypothèse de risques proportionnels :

```{r warning=FALSE}

cox.zph(m1)

plot(cox.zph(m1))

cox.zph(m2)

```



Pour le premier modèle (univarié), le test est non significatif, on peut donc penser que l'hypothèse de proportionnalité des risques est repectée.

Pour le second modèle (multivarié), le test est non significatif, on peut penser que l'hypothèse de proportionnalité des risques est repectée aussi dans ce cas.

Les courbes de survies associées à nos deux modèles (univarié et multivarié) :

```{r}

ggsurvplot(survfit(mod1), data = SData, pval = TRUE,  surv.median.line = "hv")

ggsurvplot(survfit(mod2), data = SData, pval = TRUE,  surv.median.line = "hv")

```
  
  
  

  
**Prediction :**


```{r}
SD_train=SData[1:1000,c("vital_status","time_fu","age_at_index", "ajcc_pathologic_n", "ajcc_pathologic_m", "ajcc_pathologic_t", "prior_malignancy", "prior_treatment", "radiation_therapy",  "pharmaceutical_therapy", "tumor_stage","therapy")]

SD_test=SData[1001:1081,c("age_at_index", "ajcc_pathologic_n", "ajcc_pathologic_m", "ajcc_pathologic_t", "prior_malignancy", "prior_treatment", "radiation_therapy",  "pharmaceutical_therapy", "tumor_stage","therapy")]
```


```{r}

mod2_train=coxph(formula = Surv(time_fu, vital_status) ~ age_at_index + 
    tumor_stage + ajcc_pathologic_n + ajcc_pathologic_m + prior_malignancy + 
    therapy, data = SD_train)

```


Prenons 5 individus :

```{r}

t_mod2=survfit(mod2_train, newdata = SD_test[1:5,])

plot(t_mod2, lty =c(1:5), xlab = "Time", ylab = "S(t)")

t_mod2
summary(t_mod2)

predict(mod2_train, type="risk", newdata=SD_test[1:5,], cause=1)


```

Nous avons ainsi les risques estimés par notre modèle pour les 5 individus.

