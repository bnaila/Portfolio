---
title: "Rapport de conformité de l'eCRF"
author: "Naila Bouterfa"
date: "06/01/2021"
output:
  html_document: 
    number_sections: true
    toc: true
    toc_depth: 2
    theme: united
    highlight: espresso
  pdf_document: default
header-includes:
  - \usepackage{subfig}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
## Chargements des librairies et fichiers

## librairies utilisées :

#install.packages("xlsx")
#install.packages("kableExtra")

library(dplyr)
library(magrittr)
library(tidyverse)

library(knitr)
library(xlsx)
library(kableExtra)


```



```{r echo=FALSE, message=FALSE, warning=FALSE}

#Fichiers utilisés :

eCRF=read.csv(file="C:/Users/Naila/Desktop/exercicestechniquesdeadscientiam/Exemple_eCRF_Export_Base.csv", header=TRUE, sep=';')

spes_inc=read.xlsx("C:/Users/Naila/Desktop/exercicestechniquesdeadscientiam/Exemple_eCRF_Data_Specification.xlsx", sheetName = "Inclusion" , rowIndex = 5:20, colIndex = 2:14, header=TRUE)

spes_suiv=read.xlsx("C:/Users/Naila/Desktop/exercicestechniquesdeadscientiam/Exemple_eCRF_Data_Specification.xlsx", sheetName = "Suivi" , rowIndex =  5:16, colIndex = 2:14, header=TRUE)

spes_dico=read.xlsx("C:/Users/Naila/Desktop/exercicestechniquesdeadscientiam/Exemple_eCRF_Data_Specification.xlsx", sheetName = "Dictionnaires" , rowIndex = 5:35, colIndex = 1:3, header=TRUE)
```


Nous disposons du fichier Exemple_eCRF_Export_Base.csv qui contient les données de suivi de 8 patients extraites de la base de données et de fichiers de specification associés à cette base de données. Nous procédons à des vérifications sur ce fichier pour voir si les données sont conformes au critères précisés dans le fichier de spécifications Exemple_eCRF_Data_Specification.xlsx.


# Vérifications sur les données extraites  :

## Concordance des variables

Nous allons vérifier dans un premier temps que toutes les variables décrites dans le fichier de spécifications soient aussi présentes dans le fichier de données patient (eCRF) et vice versa et génerer une liste des variables manquantes pour chaque catégorie.

La colonne eCRF fait référence aux variables mentionnées dans les spécifications qui sont absentes de l'eCRF.
La colonne spécifications fait référence aux variables mentionnées dans l'eCRF qui ne sont pas mentionnées dans les spécifications.

```{r echo=FALSE, message=FALSE, warning=FALSE}

list_ecrf=colnames(eCRF)
list_var=union(spes_suiv$NOM_VARIABLE,spes_inc$NOM_VARIABLE)

t1=list_var[!is.element(list_var,list_ecrf)]
t2=list_ecrf[!is.element(list_ecrf,list_var)]

length(t1)= max(length(t1),length(t2))
length(t2)= max(length(t1),length(t2))
options(knitr.kable.NA = '')

kbl(cbind(t1,t2) ,col.names = c("eCRF","Specifications"),caption = 'Variables manquantes')%>%
  kable_paper("hover", full_width = F,position = "center")

```


## Données manquantes

###  Vérification sur les variables obligatoires (avec exclusion des cas avec conditions)

Parmi les variables obligatoires et avec exclusion des variables qui sont associées à des conditions spécifiques, nous pouvons observer les données manquantes pour cette catégorie de variables.


```{r echo=FALSE }

#Pour chaque variable on vérifie la double condition : le champ est manquant chez les patients et le champ est associée a une variable obligatoire sans condition

list_obg=union(spes_inc$NOM_VARIABLE[spes_inc$OBLIGATOIRE==1 & is.na(spes_inc$COND_VARIABLE)==TRUE & is.na(spes_inc$COND_VARIABLE_2)==TRUE], spes_suiv$NOM_VARIABLE[spes_suiv$OBLIGATOIRE==1 & is.na(spes_suiv$COND_VARIABLE)==TRUE & is.na(spes_suiv$COND_VARIABLE_2)==TRUE])

vNA=list()
for (i in 1:25){
  if (sum(which(is.na(eCRF[,i]))>0) & colnames(eCRF)[i] %in% list_obg ){
  vNA[[colnames(eCRF)[i]]]=which(is.na(eCRF[,i]))
    } 
}

na=rep(NA,length(vNA))
for (i in 1:length(vNA)){
na[i]=kbl(vNA[[i]],col.names = names(vNA)[i],align='c')%>%kable_paper("hover", full_width = F,position = "left")
}

```


Ci dessous les résultats sont présentés en fonction des variables, ainsi chaque colonne correspond à une variable obligatoire et les lignes associées correspondent au numéro des patients pour lesquels la donnée est manquante.

```{r echo=FALSE, results='asis'}

 cat(c('<table  style="margin-left:auto;margin-right:auto;"><caption>eCRF : Valeurs obligatoires manquantes (patients manquants / variable)</caption><tr valign="top"><td>', na[1], '</td>', '<td>', na[2], '</td></tr></table>'),sep = '')

```


```{r echo=FALSE}

#On restreint eCRF à la liste de variable obligatoires avant de les contrôler
eCRF_obg=eCRF[,list_obg[is.element(list_obg,list_ecrf)]]

#On enregistre dans une liste pour chaque patient le nom des variables manquantes à l'eCRF obligatoire
varNA=rep(NA,8)
for (i in 1:8){
varNA[i]=list(colnames(eCRF_obg)[which(is.na(eCRF_obg[i,]))])
}

names(varNA)=c("Patient 1","Patient 2","Patient 3","Patient 4","Patient 5","Patient 6","Patient 7","Patient 8")

options(knitr.kable.NA = '')

na2=rep(NA,length(varNA))
for (i in 1:length(varNA)){
na2[i]=kbl(varNA[[i]],col.names = names(varNA)[i],align='c')%>%kable_paper("hover", full_width = F,position = "left")
}

```

Ci dessous les résultats sont présentés en fonction de nos 8 patients ainsi chaque colonne correspond à un patient et les lignes correspondent aux variables obligatoires pour laquelle la donnée est manquante.

```{r echo=FALSE, results='asis'}

cat(c('<table style="margin-left:auto;margin-right:auto;"><caption>eCRF : Valeurs obligatoires manquantes (variables manquantes / patient) </caption><tr valign="top"><td>', na2[1], '</td>', '<td>', na2[2], '</td>','<td>', na2[3],'</td>','<td>', na2[4],'</td>','<td>', na2[5],'</td>','<td>', na2[6], '</td>','<td>', na2[7], '</td>','<td>', na2[8], '</td></tr></table>'),sep = '')

```



### Vérifications sur les variables soumises à conditions :

Parmi les variables avec condition unique nous allons lister les valeurs manquantes.

#### Données manquantes pour les variables d'inclusion

Ci dessous nous pouvons observer pour toutes les variables avec condition unique renseignées à l'inclusion, le patient pour lequel la donnée est manquante.

Il ne devrait pas y avoir de données manquantes sur les variables obligatoires qui vérifient ces conditions.

```{r echo=FALSE}

# variables obligatoire avec condition unique

cond_inc=spes_inc[which(is.na(spes_inc$COND_VARIABLE)!=TRUE & is.na(spes_inc$COND_VARIABLE_2)==TRUE & spes_inc$OBLIGATOIRE==TRUE ),c("NOM_VARIABLE","COND_VARIABLE","COND_OPERATEUR","COND_VALEUR")]
cond_suiv=spes_suiv[which(is.na(spes_suiv$COND_VARIABLE)!=TRUE & is.na(spes_suiv$COND_VARIABLE_2)==TRUE & spes_suiv$OBLIGATOIRE==TRUE),c("NOM_VARIABLE","COND_VARIABLE","COND_OPERATEUR","COND_VALEUR")]

# si les conditions ne sont pas verifiés c'est Ok si elles sont absentes
# mais si les conditions sont verifiés et que la donnée manque, il faut signaler ce cas.

#On va chercher a voir si elle ne sont pas vérifiées avant de les inclure a nos listes

#Pour chaque variable on vérifie la double condition : le champ est manquant chez les patients et le champ est associée a une variable avec condition

#Patients qui verifient les conditions 

#cat(paste0("eCRF$ï..Patient[which(eCRF$",cond_inc$COND_VARIABLE,cond_inc$COND_OPERATEUR,cond_inc$COND_VALEUR," & is.na(eCRF$",cond_inc$NOM_VARIABLE,")==TRUE)]"))
 
p_cond_inc = list(as.vector(eCRF$ï..Patient[which(eCRF$CONSENT==1 & is.na(eCRF$SPORT)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$CONSENT%in%c(4,5) & is.na(eCRF$NAISSANCE)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$CONSENT==1 & is.na(eCRF$NIGHT)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$CONSENT==1 & is.na(eCRF$PROFESSION)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$TESTS==1 & is.na(eCRF$WHERE)==TRUE)]))

names(p_cond_inc)=c(as.character(cond_inc$NOM_VARIABLE[[1]]),as.character(cond_inc$NOM_VARIABLE[[2]]),as.character(cond_inc$NOM_VARIABLE[[3]]),as.character(cond_inc$NOM_VARIABLE[[4]]),as.character(cond_inc$NOM_VARIABLE[[5]]))

nac=rep(NA,length(p_cond_inc))
for (i in 1:length(p_cond_inc)){
nac[i]=kbl(p_cond_inc[[i]],col.names = names(p_cond_inc)[i],align='c')%>%kable_paper("hover", full_width = F,position = "left")
}

```


```{r echo=FALSE, results='asis'}

cat(c('<table  style="margin-left:auto;margin-right:auto;"><caption>eCRF : Valeurs manquantes (variables de l\'inclusion) </caption><tr valign="top"><td>', nac[1], '</td>', '<td>', nac[2], '</td>','<td>', nac[3],'</td>','<td>', nac[4],'</td>','<td>', nac[5],'</td></tr></table>'),sep = '')

```


#### Données manquantes pour les variables de suivi :

Ci dessous nous pouvons observer pour toutes les variables avec condition unique renseignées à la visite de suivi les patients pour lesquels la donnée est manquante.


```{r echo=FALSE}

#Vérification sur les conditions de suivi

#cat(paste0("eCRF$ï..Patient[which(eCRF$",cond_suiv$COND_VARIABLE,cond_suiv$COND_OPERATEUR,cond_suiv$COND_VALEUR," & is.na(eCRF$",cond_suiv$NOM_VARIABLE,")==TRUE)]"))

p_cond_suiv=list(as.vector(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$VISIT_PLACE_W2)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$WEIGHT_W2)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$TREAT_W2)==TRUE)] ), as.vector(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$TESTS_W2)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$TESTS_W2==1 & is.na(eCRF$WHERE_W2)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$TESTS_W2==0 & is.na(eCRF$REASON_W2)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$REASON_W2==2 & is.na(eCRF$REASON_OTHER_W2)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$DATE_NEXT_VISIT)==TRUE)]), as.vector(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$NEXT_DATE_PREVISION)==TRUE)]))


names(p_cond_suiv)=c(as.character(cond_suiv$NOM_VARIABLE[[1]]),as.character(cond_suiv$NOM_VARIABLE[[2]]),as.character(cond_suiv$NOM_VARIABLE[[3]]),as.character(cond_suiv$NOM_VARIABLE[[4]]),as.character(cond_suiv$NOM_VARIABLE[[5]]),as.character(cond_suiv$NOM_VARIABLE[[6]]),as.character(cond_suiv$NOM_VARIABLE[[7]]),as.character(cond_suiv$NOM_VARIABLE[[8]]),as.character(cond_suiv$NOM_VARIABLE[[9]]))

nac1=rep(NA,length(p_cond_suiv))
for (i in 1:length(p_cond_suiv)){
nac1[i]=kbl(p_cond_suiv[[i]],col.names = names(p_cond_suiv)[i],align='c')%>%kable_paper("hover", full_width = F,position = "left")
}

```


```{r echo=FALSE, results='asis'}

cat(c('<table  style="margin-left:auto;margin-right:auto;"><caption>eCRF : Valeurs manquantes (variables du suivi) </caption><tr valign="top"><td>', nac1[1], '</td>', '<td>', nac1[2], '</td>','<td>', nac1[3],'</td>','<td>', nac1[4],'</td>','<td>', nac1[5],'</td>,<td>', nac1[6],'</td>,<td>', nac1[7],'</td>,<td>', nac1[8],'</td>,<td>', nac1[9],'</td></tr></table>'),sep = '')

```

### Vérifications sur les variables soumises à double condition  :

Ci dessous nous pouvons observer pour toutes les variables obligatoires avec double conditions les patients pour lesquels la donnée est manquante.

```{r echo=FALSE}

cond2_inc=spes_inc[which(is.na(spes_inc$COND_VARIABLE_2)!=TRUE & spes_inc$OBLIGATOIRE==TRUE),c("NOM_VARIABLE","COND_VARIABLE","COND_OPERATEUR","COND_VALEUR","COND_VARIABLE_2","COND_OPERATEUR_2","COND_VALEUR_2")]
cond2_suiv=spes_suiv[which(is.na(spes_suiv$COND_VARIABLE_2)!=TRUE & spes_suiv$OBLIGATOIRE==TRUE),c("NOM_VARIABLE","COND_VARIABLE","COND_OPERATEUR","COND_VALEUR","COND_VARIABLE_2","COND_OPERATEUR_2","COND_VALEUR_2")]
cond2=rbind(cond2_inc,cond2_suiv)

#cat(paste0("eCRF$ï..Patient[which(eCRF$",cond2$COND_VARIABLE_2,cond2$COND_OPERATEUR_2,cond2$COND_VALEUR_2," & is.na(eCRF$",cond2$NOM_VARIABLE,")==TRUE)]"))

#eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & is.na(eCRF$TREAT_NAME_1_W2)==TRUE)]

p_cond_2 = list(eCRF$ï..Patient[which(eCRF$VISIT_DATE_W2!='' & eCRF$TREAT_W2==1 & is.na(eCRF$TREAT_NAME_1_W2)==TRUE)])

names(p_cond_2)=c(as.character(cond2$NOM_VARIABLE[[1]]))

kbl(p_cond_2[[1]], col.names = names(p_cond_2)[1], align='c',caption='')%>%kable_paper("hover", full_width = F,position = "center")


```

Aucun patient vérifiant la double condition n'a manquéà renseigner cette variable obligatoire.


##  Type des variables 

Verifions si le type de nos variables est correct.

```{r echo=FALSE, message=FALSE, warning=FALSE}

Type_var=apply((eCRF),2 , class)

kbl(t(Type_var[1:10]))%>%kable_styling("hover", full_width = F,position = "center")

kbl(t(Type_var[11:20]))%>%kable_styling("hover", full_width = F,position = "center")

kbl(t(Type_var[21:25]))%>%kable_styling("hover", full_width = F,position = "center")

```

Toutes les variables sont extraites au format chaine de caractère.


## Conformité au dictionnaire

Nous vérifions maintenant pour les variables avec un dictionnaire attitré, si la valeur de la variable est dans la liste prédéfinie de son dictionnaire (c'est à dire si le champ renseigné est conforme).

Ci dessous nous pouvons voir pour chaque variable avec dictionnaire, les champs renseignés qui ne sont pas conformes au dictionnaire pour chaque patient.

```{r echo=FALSE, message=FALSE, warning=FALSE}

#On selectionne parmi les specifications les variables avec dictionnaires afin d'avoir une correspondance Nom de variable/Nom de dictionnaire
dico_inc=spes_inc[which(spes_inc$NOM_DICTIONNAIRE!='NA'),c("NOM_VARIABLE","NOM_DICTIONNAIRE")]
dico_suiv=spes_suiv[which(spes_suiv$NOM_DICTIONNAIRE!='NA'),c("NOM_VARIABLE","NOM_DICTIONNAIRE")]
dico=rbind(dico_inc,dico_suiv) #Il y a 14 elements dans le dictionnaire


#Parmi l'eCRF on selectionne seulement les données pour les variables associées à un dictionnaire afin de faire des Vérifications de conformité sur celles ci :
eCRF_dico=eCRF[,as.vector(dico$NOM_VARIABLE)]


#On modifie spes_dico, pour rendre la vérification plus simple 

spes_dico_m=spes_dico

val=spes_dico_m$NOM_DICTIONNAIRE[1]
for (i in 1:dim(spes_dico_m)[1]){
if (is.na(spes_dico_m$NOM_DICTIONNAIRE[i])==TRUE)
{spes_dico_m$NOM_DICTIONNAIRE[i]=val}
else {val=spes_dico_m$NOM_DICTIONNAIRE[i]}
}

#Pour chaque variable de eCRF_dico, on verifie que les elements associées appartient à l'ensemble des valeurs prise dans le dictionnaire associé

#On veut vérifier à la foi que la donnée soit conforme au dictionnaire mais seulement pour les valeurs présentes (exclusion des NA et champs vide)

tab=matrix("non verifié",dim(eCRF_dico)[1],dim(eCRF_dico)[2])
for (i in 1:dim(eCRF_dico)[2]){
  for (j in 1:dim(eCRF_dico)[1]){
    nom_dico=dico$NOM_DICTIONNAIRE[dico$NOM_VARIABLE==colnames(eCRF_dico)[i]]
    tab[j,i]= (eCRF_dico[j,i]%in%spes_dico_m$CODE_REPONSE[spes_dico_m$NOM_DICTIONNAIRE==nom_dico]==FALSE & is.na(eCRF_dico[j,i])==FALSE)
  }
}

colnames(tab)=colnames(eCRF_dico)

eCRF_dico_bad=eCRF_dico
eCRF_dico_bad[tab==FALSE]=''
eCRF_dico_bad=cbind(Patient=eCRF$ï..Patient,eCRF_dico_bad)

kbl(eCRF_dico_bad,align='c',caption = 'Données non conformes au dictionnaires')%>%kable_paper("hover", full_width = F,position = "left")

```


# Synthèse :

- Bien qu'il semblerait que les variables **Patient** (dans les specifications) et **ï..Patient** (dans l'eCRF) expriment la même information d'une manière différente. Il est nécessaire d'uniformiser la notation.
Ensuite les variables **INIT** et **TELEPHONE** mentionnées dans les spécifications ne sont même pas citées dans l'eCRF.
De même pour la variable **WORK** présente dans l'eCRF et absente des spécifications.


- Pour les patients 2, 3, 4, 5  il nous manque l'information du consentement dans la variable **CONSENT** et pour le patient 6 la donnée **TASK** est manquante, toutes deux obligatoires.


- Le patient 1, n'a pas renseigné la variable **NIGHT** et le patient 5 les variables **WHERE**, **VISIT_PLACE_W2**, **WEIGHT_W2**, **TREAT_W2**, le patient 6, les variables **VISIT_PLACE_W2**, **WEIGHT_W2** et **TREAT_W2** et le patient 7 les variables **WHERE**, **VISIT_PLACE_W2** et **WHERE_W2**.

- Nous avons aussi des champs non conformes, chez le patient 1 avec la variable **VISITE** et **TESTS_W2**, pour le patient 2 avec les variables **SPORT**, **PROFESSION** et **TESTS_W2** pour le patient 4 avec **PHYSIQUE** et **VISIT_PLACE_W2**, pour le patient 5 avec les variables **NIGHT** et **PROFESSION** et enfin pour le patient 6 avec la variable **PHYSIQUE**.


